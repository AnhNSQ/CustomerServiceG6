<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tất cả Ticket - Staff</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color:#dc3545; --secondary-color:#6c757d; --success-color:#28a745; --danger-color:#dc3545; }
        body { background:#f7fafc; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .page-header { background:linear-gradient(135deg, #dc3545, #c82333); color:#fff; padding:1.5rem 0; margin-bottom:1.5rem; }
        .dashboard-card { background:#fff; border-radius:15px; padding:1.25rem; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin-bottom:1.25rem; }
        .section-title { color:#2d3748; font-weight:700; margin-bottom:1rem; display:flex; align-items:center; }
        .section-title i { margin-right:.5rem; color:var(--primary-color); }
        .ticket-item { background:#f8f9fa; border-radius:10px; padding:1rem; margin-bottom:1rem; border-left:4px solid var(--primary-color); }
        .status-badge { padding:.4rem .8rem; border-radius:20px; font-size:.8rem; font-weight:600; }
        .status-open { background:#cce5ff; color:#004085; }
        .status-in-progress { background:#fff3cd; color:#856404; }
        .status-resolved { background:#d4edda; color:#155724; }
        .status-closed { background:#e2e3e5; color:#495057; }
        .btn-linkish { background:rgba(255,255,255,0.2); border:2px solid #fff; color:#fff; padding:.5rem 1rem; border-radius:8px; font-weight:600; transition:all 0.3s ease; }
        .btn-linkish:hover { background:rgba(255,255,255,0.3); transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,0.2); }
        .header-actions a { color:#fff; text-decoration:none; }
        
        /* Button Styles */
        .btn { border-radius:8px; padding:8px 16px; font-weight:600; transition:all 0.3s ease; }
        .btn-primary { background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border:none; box-shadow:0 4px 10px rgba(102,126,234,0.3); }
        .btn-primary:hover { background:linear-gradient(135deg, var(--secondary-color), #6a4c93); transform:translateY(-2px); box-shadow:0 6px 15px rgba(102,126,234,0.4); }
        .btn-outline-primary { border:2px solid var(--primary-color); color:var(--primary-color); }
        .btn-outline-primary:hover { background:var(--primary-color); border-color:var(--primary-color); color:white; transform:translateY(-2px); box-shadow:0 4px 10px rgba(102,126,234,0.3); }
        .btn-outline-danger { border:2px solid var(--danger-color); color:var(--danger-color); }
        .btn-outline-danger:hover { background:var(--danger-color); border-color:var(--danger-color); color:white; transform:translateY(-2px); box-shadow:0 4px 10px rgba(245,101,101,0.3); }
        .btn-sm { padding:4px 8px; font-size:0.8rem; border-radius:6px; }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0"><i class="fas fa-ticket-alt me-2"></i>Tickets được giao</h2>
                <div class="small" th:if="${staff != null}">
                    <i class="fas fa-id-badge me-1"></i><span th:text="${staff.name}">Nhân viên</span>
                </div>
            </div>
            <div class="header-actions">
                <a class="btn-linkish me-2" href="/staff/dashboard"><i class="fas fa-arrow-left me-1"></i>Về Dashboard</a>
                <a class="btn-linkish" href="#" onclick="logout(); return false;"><i class="fas fa-sign-out-alt me-1"></i>Đăng xuất</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-card">
            <h5 class="section-title" style="color: #dc3545;"><i class="fas fa-filter"></i> Bộ lọc</h5>
            <div class="row g-2">
                <div class="col-sm-6 col-md-4">
                    <select id="statusFilter" class="form-select">
                        <option value="">Tất cả trạng thái</option>
                        <option value="OPEN">Mở (OPEN)</option>
                        <option value="IN_PROGRESS">Đang xử lý (IN_PROGRESS)</option>
                        <option value="RESOLVED">Đã giải quyết (RESOLVED)</option>
                        <option value="CLOSED">Đã đóng (CLOSED)</option>
                    </select>
                </div>
                <div class="col-sm-6 col-md-4">
                    <select id="priorityFilter" class="form-select">
                        <option value="">Tất cả ưu tiên</option>
                        <option value="LOW">Thấp (LOW)</option>
                        <option value="MEDIUM">Trung bình (MEDIUM)</option>
                        <option value="HIGH">Cao (HIGH)</option>
                    </select>
                </div>
                <div class="col-sm-12 col-md-4">
                    <input id="searchInput" class="form-control" placeholder="Tìm theo tiêu đề hoặc mô tả...">
                </div>
            </div>
        </div>

        <div id="ticketsCard" class="dashboard-card">
            <h5 class="section-title" style="color: #dc3545;"><i class="fas fa-ticket-alt"></i> Tickets được giao</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead style="background: linear-gradient(135deg, #dc3545, #c82333); color: white;">
                        <tr>
                            <th style="border-color: rgba(255,255,255,0.3);">ID</th>
                            <th style="border-color: rgba(255,255,255,0.3);">Tiêu đề</th>
                            <th style="border-color: rgba(255,255,255,0.3);">Khách hàng</th>
                            <th style="border-color: rgba(255,255,255,0.3);">Ưu tiên</th>
                            <th style="border-color: rgba(255,255,255,0.3);">Trạng thái</th>
                            <th style="border-color: rgba(255,255,255,0.3);">Ngày tạo</th>
                            <th style="border-color: rgba(255,255,255,0.3);">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsContent">
                        <!-- Tickets will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let allTickets = [];
        
        // Debounce utility to limit frequent filter calls while typing
        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Load initial data
            loadTickets();
            
            // Auto-apply filters when controls change
            const statusEl = document.getElementById('statusFilter');
            const priorityEl = document.getElementById('priorityFilter');
            const searchEl = document.getElementById('searchInput');
            
            if (statusEl) statusEl.addEventListener('change', applyFilters);
            if (priorityEl) priorityEl.addEventListener('change', applyFilters);
            if (searchEl) searchEl.addEventListener('input', debounce(applyFilters, 300));
        });

        function logout() {
            fetch('/api/staff/logout', { method:'POST', headers:{'Content-Type':'application/json'} })
              .then(r=>r.json()).then(d=>{ window.location.href = '/staff/login'; })
              .catch(()=>{ window.location.href = '/staff/login'; });
        }

        function loadTickets() {
            const content = document.getElementById('ticketsContent');
            content.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Đang tải danh sách ticket...</p></div>';
            fetch('/api/staff/tickets/assigned', { 
                method: 'GET', 
                headers: { 'Accept': 'application/json' },
                credentials: 'include'
            })
              .then(async res => {
                // Handle non-OK responses (e.g., 401 or server errors)
                if (!res.ok) {
                  let msg = `Không thể tải danh sách ticket (HTTP ${res.status})`;
                  try {
                    const ct = res.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                      const j = await res.json();
                      msg = j.message || msg;
                    } else {
                      const t = await res.text();
                      if (res.status === 401 || (typeof t === 'string' && t.toLowerCase().includes('login'))) {
                        msg = 'Bạn chưa đăng nhập. Vui lòng đăng nhập lại.';
                      }
                    }
                  } catch (_) { /* ignore parse errors */ }
                  content.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="alert alert-danger"><i class='fas fa-exclamation-triangle me-2'></i>${msg}</div></td></tr>`;
                  // Suggest redirect for unauthorized
                  if (res.status === 401) {
                    setTimeout(() => { window.location.href = '/staff/login'; }, 1200);
                  }
                  return null;
                }
                // Parse OK JSON
                try {
                  return await res.json();
                } catch (e) {
                  console.error('JSON parse error:', e);
                  content.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Dữ liệu trả về không hợp lệ</div></td></tr>';
                  return null;
                }
              })
              .then(api => {
                if (!api) return; // handled above
                if (!api.success) {
                  content.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="alert alert-danger"><i class=\"fas fa-exclamation-triangle me-2\"></i>${api.message || 'Không thể tải danh sách ticket'}</div></td></tr>`;
                  return;
                }
                allTickets = api.data || [];
                applyFilters();
              })
              .catch(err => {
                console.error('Fetch error:', err);
                content.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Có lỗi xảy ra khi tải dữ liệu</div></td></tr>';
              });
        }

        function applyFilters(){
            const statusEl = document.getElementById('statusFilter');
            const priorityEl = document.getElementById('priorityFilter');
            const searchEl = document.getElementById('searchInput');
            
            const status = statusEl ? statusEl.value : '';
            const priority = priorityEl ? priorityEl.value : '';
            const q = searchEl ? (searchEl.value || '').toLowerCase() : '';
            
            const filtered = allTickets.filter(t=>{
                const okStatus = !status || (t.status||'')===status;
                const okPri = !priority || (t.priority||'')===priority;
                const okQ = !q || (String(t.subject||'').toLowerCase().includes(q) || String(t.description||'').toLowerCase().includes(q));
                return okStatus && okPri && okQ;
            });
            renderTickets(filtered);
        }

        function renderTickets(tickets){
            const content = document.getElementById('ticketsContent');
            if(!tickets || tickets.length===0){
                content.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>Chưa có ticket nào được giao cho bạn</p>
                        </td>
                    </tr>`;
                return;
            }
            const html = tickets.map((t, index) => renderTicketItem(t, index)).join('');
            content.innerHTML = html;
        }

        function renderTicketItem(t, index){
            const statusClass = mapStatusToClass(t.status);
            const createdAt = formatDateTime(t.createdAt);
            return `
                <tr style="border-bottom: 1px solid #e9ecef;" onmouseover="this.style.backgroundColor='rgba(220, 53, 69, 0.05)';" onmouseout="this.style.backgroundColor='white';">
                    <td><strong>${index + 1}</strong></td>
                    <td><strong style="color: #dc3545;">${escapeHtml(t.subject || 'N/A')}</strong></td>
                    <td>${escapeHtml(t.customerName || 'N/A')}</td>
                    <td>
                        <span class="badge ${getPriorityClass(t.priority)}">
                            ${t.priority || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${getStatusClass(t.status)}">
                            ${t.status || 'N/A'}
                        </span>
                    </td>
                    <td>${createdAt}</td>
                    <td>
                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none;" onclick="viewTicketDetail(${t.ticketId})">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>`;
        }
        
        function getPriorityClass(priority) {
            switch(priority) {
                case 'HIGH': return 'bg-danger';
                case 'MEDIUM': return 'bg-warning';
                case 'LOW': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'OPEN': return 'bg-success';
                case 'IN_PROGRESS': return 'bg-primary';
                case 'RESOLVED': return 'bg-success';
                case 'CLOSED': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }
        
        function viewTicketDetail(ticketId) {
            window.location.href = `/staff/tickets/${ticketId}`;
        }

        function mapStatusToClass(status){
            switch((status||'').toUpperCase()){
                case 'OPEN': return 'status-open';
                case 'ASSIGNED': return 'status-in-progress';
                case 'IN_PROGRESS': return 'status-in-progress';
                case 'RESOLVED': return 'status-resolved';
                case 'CLOSED': return 'status-closed';
                default: return 'status-open';
            }
        }
        function formatDateTime(iso){ try{ if(!iso) return ''; const d=new Date(iso); const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }catch{return '';} }
        function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    </script>
</body>
</html>
