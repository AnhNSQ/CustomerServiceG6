<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tất cả Ticket - Staff</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color:#667eea; --secondary-color:#764ba2; --success-color:#48bb78; --danger-color:#f56565; }
        body { background:#f7fafc; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .page-header { background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:#fff; padding:1.5rem 0; margin-bottom:1.5rem; }
        .dashboard-card { background:#fff; border-radius:15px; padding:1.25rem; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin-bottom:1.25rem; }
        .section-title { color:#2d3748; font-weight:700; margin-bottom:1rem; display:flex; align-items:center; }
        .section-title i { margin-right:.5rem; color:var(--primary-color); }
        .ticket-item { background:#f8f9fa; border-radius:10px; padding:1rem; margin-bottom:1rem; border-left:4px solid var(--primary-color); }
        .status-badge { padding:.4rem .8rem; border-radius:20px; font-size:.8rem; font-weight:600; }
        .status-open { background:#cce5ff; color:#004085; }
        .status-in-progress { background:#fff3cd; color:#856404; }
        .status-resolved { background:#d4edda; color:#155724; }
        .status-closed { background:#e2e3e5; color:#495057; }
        .btn-linkish { background:rgba(255,255,255,0.2); border:2px solid #fff; color:#fff; padding:.5rem 1rem; border-radius:8px; font-weight:600; }
        .header-actions a { color:#fff; text-decoration:none; }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0"><i class="fas fa-list-ul me-2"></i>Tất cả Ticket</h2>
                <div class="small" th:if="${staff != null}">
                    <i class="fas fa-id-badge me-1"></i><span th:text="${staff.name}">Nhân viên</span>
                </div>
            </div>
            <div class="header-actions">
                <a class="btn-linkish me-2" href="/staff/dashboard"><i class="fas fa-arrow-left me-1"></i>Về Dashboard</a>
                <a class="btn-linkish" href="#" onclick="logout(); return false;"><i class="fas fa-sign-out-alt me-1"></i>Đăng xuất</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-card">
            <h5 class="section-title"><i class="fas fa-filter"></i>Bộ lọc</h5>
            <div class="row g-2">
                <div class="col-sm-6 col-md-4">
                    <select id="statusFilter" class="form-select">
                        <option value="">Tất cả trạng thái</option>
                        <option value="OPEN">Mở</option>
                        <option value="ASSIGNED">Đã giao</option>
                        <option value="IN_PROGRESS">Đang xử lý</option>
                        <option value="RESOLVED">Đã giải quyết</option>
                        <option value="CLOSED">Đã đóng</option>
                    </select>
                </div>
                <div class="col-sm-6 col-md-4">
                    <select id="priorityFilter" class="form-select">
                        <option value="">Tất cả ưu tiên</option>
                        <option value="LOW">Thấp</option>
                        <option value="MEDIUM">Trung bình</option>
                        <option value="HIGH">Cao</option>
                    </select>
                </div>
                <div class="col-sm-12 col-md-4">
                    <input id="searchInput" class="form-control" placeholder="Tìm theo tiêu đề hoặc mô tả...">
                </div>
            </div>
        </div>

        <div id="ticketsCard" class="dashboard-card">
            <h5 class="section-title"><i class="fas fa-list"></i>Danh sách Ticket</h5>
            <div id="ticketsContent"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let allTickets = [];
        
        // Debounce utility to limit frequent filter calls while typing
        function debounce(fn, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), delay);
            };
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Load initial data
            loadTickets();
            
            // Auto-apply filters when controls change
            const statusEl = document.getElementById('statusFilter');
            const priorityEl = document.getElementById('priorityFilter');
            const searchEl = document.getElementById('searchInput');
            
            if (statusEl) statusEl.addEventListener('change', applyFilters);
            if (priorityEl) priorityEl.addEventListener('change', applyFilters);
            if (searchEl) searchEl.addEventListener('input', debounce(applyFilters, 300));
        });

        function logout() {
            fetch('/api/staff/logout', { method:'POST', headers:{'Content-Type':'application/json'} })
              .then(r=>r.json()).then(d=>{ window.location.href = '/staff/login'; })
              .catch(()=>{ window.location.href = '/staff/login'; });
        }

        function loadTickets() {
            const content = document.getElementById('ticketsContent');
            content.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Đang tải danh sách ticket...</p></div>';
            fetch('/api/staff/tickets/all', { 
                method: 'GET', 
                headers: { 'Accept': 'application/json' },
                credentials: 'include'
            })
              .then(async res => {
                // Handle non-OK responses (e.g., 401 or server errors)
                if (!res.ok) {
                  let msg = `Không thể tải danh sách ticket (HTTP ${res.status})`;
                  try {
                    const ct = res.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                      const j = await res.json();
                      msg = j.message || msg;
                    } else {
                      const t = await res.text();
                      if (res.status === 401 || (typeof t === 'string' && t.toLowerCase().includes('login'))) {
                        msg = 'Bạn chưa đăng nhập. Vui lòng đăng nhập lại.';
                      }
                    }
                  } catch (_) { /* ignore parse errors */ }
                  content.innerHTML = `<div class="alert alert-danger"><i class='fas fa-exclamation-triangle me-2'></i>${msg}</div>`;
                  // Suggest redirect for unauthorized
                  if (res.status === 401) {
                    setTimeout(() => { window.location.href = '/staff/login'; }, 1200);
                  }
                  return null;
                }
                // Parse OK JSON
                try {
                  return await res.json();
                } catch (e) {
                  console.error('JSON parse error:', e);
                  content.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Dữ liệu trả về không hợp lệ</div>';
                  return null;
                }
              })
              .then(api => {
                if (!api) return; // handled above
                if (!api.success) {
                  content.innerHTML = `<div class="alert alert-danger"><i class=\"fas fa-exclamation-triangle me-2\"></i>${api.message || 'Không thể tải danh sách ticket'}</div>`;
                  return;
                }
                allTickets = api.data || [];
                // Respect current filter controls when data arrives
                applyFilters();
              })
              .catch(err => {
                console.error('Fetch error:', err);
                content.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Có lỗi xảy ra khi tải dữ liệu</div>';
              });
        }

        function applyFilters(){
            const status = document.getElementById('statusFilter').value;
            const priority = document.getElementById('priorityFilter').value;
            const q = (document.getElementById('searchInput').value || '').toLowerCase();
            const filtered = allTickets.filter(t=>{
                const okStatus = !status || (t.status||'')===status;
                const okPri = !priority || (t.priority||'')===priority;
                const okQ = !q || (String(t.subject||'').toLowerCase().includes(q) || String(t.description||'').toLowerCase().includes(q));
                return okStatus && okPri && okQ;
            });
            renderTickets(filtered);
        }

        function renderTickets(tickets){
            const content = document.getElementById('ticketsContent');
            if(!tickets || tickets.length===0){
                content.innerHTML = '<div class="text-center py-4"><i class="fas fa-inbox fa-3x text-muted mb-3"></i><p class="text-muted">Chưa có ticket nào</p></div>';
                return;
            }
            const html = tickets.map(renderTicketItem).join('');
            content.innerHTML = html;
        }

        function renderTicketItem(t){
            const statusClass = mapStatusToClass(t.status);
            const createdAt = formatDateTime(t.createdAt);
            return `
                <div class="ticket-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">#${t.ticketId} - ${escapeHtml(t.subject)}</h6>
                            <p class="text-muted mb-2">${escapeHtml(t.description || '')}</p>
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>
                                Customer ID: ${t.customerId}
                                <i class="fas fa-calendar ms-3 me-1"></i>
                                ${createdAt}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="status-badge ${statusClass}">${t.status}</span>
                            <br>
                            <small class="text-muted mt-1 d-block">${t.priority}</small>
                        </div>
                    </div>
                </div>`;
        }

        function mapStatusToClass(status){
            switch((status||'').toUpperCase()){
                case 'OPEN': return 'status-open';
                case 'ASSIGNED': return 'status-in-progress';
                case 'IN_PROGRESS': return 'status-in-progress';
                case 'RESOLVED': return 'status-resolved';
                case 'CLOSED': return 'status-closed';
                default: return 'status-open';
            }
        }
        function formatDateTime(iso){ try{ if(!iso) return ''; const d=new Date(iso); const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }catch{return '';} }
        function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    </script>
</body>
</html>
