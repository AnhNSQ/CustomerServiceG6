<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Ticket - Leader Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #dc3545;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
        }

        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 2rem auto;
            max-width: 1400px;
            padding: 2rem;
        }

        .page-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }

        .page-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: linear-gradient(135deg, var(--primary-color), #c82333);
            color: white;
            border: none;
            font-weight: 600;
            padding: 1rem;
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #e9ecef;
        }

        .table tbody tr:hover {
            background-color: rgba(220, 53, 69, 0.05);
        }

        .badge {
            font-size: 0.8rem;
            padding: 0.5rem 0.8rem;
            border-radius: 20px;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), #c82333);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #c82333, #b02a37);
        }

        .loading-spinner {
            text-align: center;
            padding: 3rem;
        }

        .error-message {
            text-align: center;
            padding: 3rem;
            color: var(--danger-color);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--secondary-color);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Modal styles */
        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #c82333);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.8rem 1rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/leader/dashboard">
                <i class="fas fa-crown me-2"></i>Leader Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/leader/dashboard">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <a class="nav-link active" href="/leader/tickets">
                    <i class="fas fa-ticket-alt me-1"></i>Tickets
                </a>
                <a class="nav-link" href="/leader/staff">
                    <i class="fas fa-users me-1"></i>Nhân viên
                </a>
                <a class="nav-link" href="/staff/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Đăng xuất
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-container">
            <!-- Loading State -->
            <div id="loadingState" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-3 text-muted">Đang tải danh sách ticket...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h5>Không thể tải danh sách ticket</h5>
                <p>Bạn không có quyền truy cập hoặc có lỗi xảy ra.</p>
                <a href="/leader/dashboard" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-1"></i>Quay lại Dashboard
                </a>
            </div>

            <!-- Content -->
            <div id="contentState" style="display: none;">
                <!-- Header -->
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-ticket-alt me-2"></i>Quản lý Ticket
                    </h1>
                    <p class="text-muted mb-0">Xem và phân công ticket của phòng ban</p>
                </div>

                <!-- Tickets Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tiêu đề</th>
                                <th>Khách hàng</th>
                                <th>Trạng thái</th>
                                <th>Độ ưu tiên</th>
                                <th>Ngày tạo</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsTableBody">
                            <!-- Tickets will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="fas fa-ticket-alt"></i>
                    <h5>Chưa có ticket nào</h5>
                    <p>Phòng ban của bạn chưa có ticket nào được gửi đến.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Ticket Modal -->
    <div class="modal fade" id="assignModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Phân công Ticket
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="assignForm">
                        <input type="hidden" id="assignTicketId">
                        
                        <!-- Ticket Info -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-2">Thông tin Ticket</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div id="ticketInfo">
                                        <!-- Ticket info will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Staff Selection -->
                        <div class="mb-3">
                            <label for="staffSelect" class="form-label">
                                <i class="fas fa-user me-1"></i>Chọn nhân viên *
                            </label>
                            <select class="form-select" id="staffSelect" required>
                                <option value="">-- Chọn nhân viên --</option>
                            </select>
                        </div>

                        <!-- Note -->
                        <div class="mb-3">
                            <label for="assignNote" class="form-label">
                                <i class="fas fa-sticky-note me-1"></i>Ghi chú
                            </label>
                            <textarea class="form-control" id="assignNote" rows="3" 
                                placeholder="Nhập ghi chú cho nhân viên..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Hủy
                    </button>
                    <button type="button" class="btn btn-primary" onclick="assignTicket()">
                        <i class="fas fa-check me-1"></i>Phân công
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="position-fixed" style="top: 20px; right: 20px; z-index: 9999;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let tickets = [];
        let staff = [];

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTickets();
            loadStaff();
        });

        function loadTickets() {
            fetch('/api/staff/leader/tickets', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        tickets = data.data;
                        displayTickets();
                        showContent();
                    } else {
                        showError();
                    }
                })
                .catch(error => {
                    console.error('Error loading tickets:', error);
                    showError();
                });
        }

        function loadStaff() {
            fetch('/api/staff/leader/staff', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        staff = data.data;
                    }
                })
                .catch(error => {
                    console.error('Error loading staff:', error);
                });
        }

        function displayTickets() {
            const tbody = document.getElementById('ticketsTableBody');
            
            if (tickets.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }

            const ticketsHtml = tickets.map((ticket, index) => `
                <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td>
                        <div class="fw-bold">${ticket.subject}</div>
                        <small class="text-muted">${ticket.description.substring(0, 50)}${ticket.description.length > 50 ? '...' : ''}</small>
                    </td>
                    <td>
                        <div class="fw-bold">${ticket.customerName}</div>
                        <small class="text-muted">${ticket.customerEmail}</small>
                    </td>
                    <td>
                        <span class="badge ${getStatusClass(ticket.status)}">
                            ${getStatusText(ticket.status)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${getPriorityClass(ticket.priority)}">
                            ${getPriorityText(ticket.priority)}
                        </span>
                    </td>
                    <td>
                        <small>${formatDate(ticket.createdAt)}</small>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-primary" 
                                onclick="openAssignModal(${ticket.ticketId})" 
                                title="Phân công ticket">
                                <i class="fas fa-user-plus"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            tbody.innerHTML = ticketsHtml;
        }

        function openAssignModal(ticketId) {
            const ticket = tickets.find(t => t.ticketId === ticketId);
            if (!ticket) return;

            // Set ticket ID
            document.getElementById('assignTicketId').value = ticketId;

            // Display ticket info
            document.getElementById('ticketInfo').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Tiêu đề:</strong> ${ticket.subject}
                    </div>
                    <div class="col-md-6">
                        <strong>Khách hàng:</strong> ${ticket.customerName}
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <strong>Trạng thái:</strong> 
                        <span class="badge ${getStatusClass(ticket.status)}">${getStatusText(ticket.status)}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Độ ưu tiên:</strong> 
                        <span class="badge ${getPriorityClass(ticket.priority)}">${getPriorityText(ticket.priority)}</span>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <strong>Mô tả:</strong><br>
                        <small class="text-muted">${ticket.description}</small>
                    </div>
                </div>
            `;

            // Populate staff dropdown
            const staffSelect = document.getElementById('staffSelect');
            staffSelect.innerHTML = '<option value="">-- Chọn nhân viên --</option>';
            
            staff.forEach(s => {
                const option = document.createElement('option');
                option.value = s.staffId;
                option.textContent = `${s.name} (${s.email})`;
                staffSelect.appendChild(option);
            });

            // Show modal
            new bootstrap.Modal(document.getElementById('assignModal')).show();
        }

        function assignTicket() {
            const ticketId = document.getElementById('assignTicketId').value;
            const staffId = document.getElementById('staffSelect').value;
            const note = document.getElementById('assignNote').value;

            if (!staffId) {
                showAlert('Vui lòng chọn nhân viên', 'warning');
                return;
            }

            const requestData = {
                staffId: parseInt(staffId),
                note: note
            };

            fetch(`/api/staff/leader/tickets/${ticketId}/assign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Phân công ticket thành công!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
                    loadTickets(); // Reload tickets
                } else {
                    showAlert(data.message || 'Có lỗi xảy ra khi phân công ticket', 'danger');
                }
            })
            .catch(error => {
                console.error('Error assigning ticket:', error);
                showAlert('Có lỗi xảy ra khi phân công ticket', 'danger');
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'OPEN': return 'bg-warning';
                case 'ASSIGNED': return 'bg-info';
                case 'IN_PROGRESS': return 'bg-primary';
                case 'RESOLVED': return 'bg-success';
                case 'CLOSED': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'OPEN': return 'Mở';
                case 'ASSIGNED': return 'Đã phân công';
                case 'IN_PROGRESS': return 'Đang xử lý';
                case 'RESOLVED': return 'Đã giải quyết';
                case 'CLOSED': return 'Đã đóng';
                default: return status;
            }
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'LOW': return 'bg-success';
                case 'MEDIUM': return 'bg-warning';
                case 'HIGH': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function getPriorityText(priority) {
            switch(priority) {
                case 'LOW': return 'Thấp';
                case 'MEDIUM': return 'Trung bình';
                case 'HIGH': return 'Cao';
                default: return priority;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentState').style.display = 'block';
        }

        function showError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    bootstrap.Alert.getOrCreateInstance(alert).close();
                }
            }, 5000);
        }
    </script>
</body>
</html>


